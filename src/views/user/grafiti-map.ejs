<%- include("../templates/header.ejs", { tipoNavbar: "logged" , tituloPestana: "Mapa de grafitis" , username: user.name,
    index: 3 }) %>

    <div class="container-fluid p-0 m-0">
        <div class="" id="map" style="height: 600px; width: auto;"></div>
    </div>

    <script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>
    <script async>

        const markers = [];

        // Initialize and add the map
        async function initMap() {

            // El geocoder, convierte direcciones a coordenadas y viceversa
            const geocoder = new google.maps.Geocoder();

            // Convierte una direcci칩n en una coordenada y apunta en el mapa a ella
            /*function geocodeAddress(geocoder, resultsMap, address) {
                geocoder.geocode({ address, bounds: resultsMap.getBounds() }, (results, status) => {
                    if (status === "OK") {

                        // Ajustamos el mapa a los resultados
                        resultsMap.fitBounds(results[0].geometry.viewport);

                        geocoder.geocode({ location: results[0].geometry.location }, (results, status) => {
                            if (status === "OK") {
                                if (results[0]) {
                                    document.getElementById("direccion").value = results[0].formatted_address;
                                } else {
                                    window.alert("No results found");
                                }
                            } else {
                                window.alert("Geocoder failed due to: " + status);
                            }
                        });

                    } else {
                        alert("Geocode was not successful for the following reason: " + status);
                    }
                });
            }*/

            // The map, centered at grafiti coords
            const map = new google.maps.Map(document.getElementById("map"), {
                disableDefaultUI: true,
            });

            // Obtenemos las coordenadas de la localizaci칩n inicial, en este caso, Espa침a
            const initCoords = {};
            geocoder.geocode({ address: "Spain" }, async (results, status) => {
                if (status === "OK") {

                    // Recogemos las coordenadas devueltas por el geocoder
                    const loc = results[0].geometry.location;
                    initCoords["lat"] = await loc.lat();
                    initCoords["lng"] = await loc.lng();

                    // Ajustamos el viewport al resultado
                    map.fitBounds(results[0].geometry.viewport);

                } else {
                    alert("Geocode was not successful for the following reason: " + status);
                }
            });

            const data = await fetch("/api/grafitis/get-grafitis-with-gps", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            const respuesta = await data.json();
            //console.log(respuesta)
            if (!respuesta) {
                window.location.href = "/usuario";
            } else
                if (!respuesta.success) {
                    window.location.href = "/usuario";
                }

            const grafitis = respuesta.grafitis;
/*
            const svgMarker = {
                path: "M10.453 14.016l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM12 2.016q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                fillOpacity: 0.75,
                strokeWeight: 0,
                rotation: 0,
                scale: 2,
                anchor: new google.maps.Point(15, 30),
            };
*/
            grafitis.forEach(grafiti => {

                /*const userId = `<%= user._id %>`;
                if (grafiti.user === userId) {
                    svgMarker["fillColor"] = "green";
                } else {
                    svgMarker["fillColor"] = "blue";
                }*/

                const marker = new google.maps.Marker({
                    map: map,
                    position: {
                        lat: grafiti.gps.location.coordinates[1],
                        lng: grafiti.gps.location.coordinates[0],
                    },
                    //icon: svgMarker,
                    url: "/usuario/grafiti/" + grafiti._id,
                });
                google.maps.event.addListener(marker, "click", () => {
                    window.location.href = marker.url;
                });
                markers.push(marker);
            });

            var markerCluster = new MarkerClusterer(map, markers, {
                imagePath:
                "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
                maxZoom: 18,
                gridSize: 20
            });

        }

    </script>

    <%# Script de la api de maps; debe ir tras la funci칩n initMap %>
    <script src="https://maps.googleapis.com/maps/api/js?key=<%= maps_key %>&callback=initMap&libraries=&v=weekly" async></script>

        <%- include('../templates/footer'); %>