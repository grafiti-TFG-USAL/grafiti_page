<%- include("../templates/header.ejs", { tipoNavbar: "logged" , tituloPestana: "Grafiti DB" , username: user.name,
    index: 2 }) %>

    <div class="container-fluid my-4">
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h3 class="d-inline">Grafiti DB</h3>
                        <div class="btn-group float-right">
                            <button class="d-inline dropdown-toggle btn btn-info" type="button"
                                data-toggle="dropdown">Filtrar
                                <!--span class="material-icons-outlined">filter_list</span--> <i class="fa fa-bars"
                                    aria-hidden="true"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" type="button" data-toggle="modal"
                                    data-target="#filtro-zona">por zona <i class="fa fa-map-marker ml-1"
                                        aria-hidden="true"></i>
                                </a>
                                <a class="dropdown-item" type="button" data-toggle="modal"
                                    data-target="#filtro-zona">por fecha <i class="fa fa-calendar ml-1"
                                        aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <% if (grafitis.length> 0) { %>
                            <div class="row">
                                <% for(const image of grafitis) { %>
                                    <div class="col-4 col-sm-3 col-lg-2 mb-2" style="position: relative">
                                        <a class="" href="/usuario/grafiti/<%= image._id %>">
                                            <img src="/api/grafitis/get-thumbnail/<%= image._id %>"
                                                alt="<%= image.description %>" class="w-100 h-100 img img-thumbnail"
                                                style="display: block">
                                            <%# if (image.gps) { %>
                                                <!--i class="fa fa-map-marker-alt"
                                                    style="position: absolute; bottom:0; left:0;"></i-->
                                                <%# } %>
                                        </a>
                                        <!--div class="row">
                                            <a class="card-link col" href="">
                                                <span class="text-dark small float-right"><#%= image.user.email %></span>
                                            </a>
                                        </div-->
                                    </div>
                                    <% } %>
                            </div>
                            <% } else { %>
                                <h3 class="display-4 text-center justify-content-center">No hay grafitis</h3>
                                <% } %>
                    </div>

                    <div class="card-footer">
                        <!-- ELEMENTO DE PAGINACIÓN -->
                        <%- include("../templates/pagination.ejs", { pagina, limPages }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CODIGO DEL MODAL DE FILTRO POR ZONA -->
    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" id="filtro-zona">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Seleccione el centro</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="floating-panel">
                        <div class="row mx-2">
                            <div class="input-group">
                                <input id="direccion" type="text" class="form-control" placeholder="Dirección"
                                    autocomplete="off">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-success"
                                        id="buscar_direccion">Buscar</button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <label class="d-inline" for="radius">Radio de búsqueda: </label>
                        <label id="showRadius" class="d-inline">5 km</label>
                        <input type="range" class="d-block mt-2 col-11 p-0" autocomplete="off" min="0.1" max="200"
                            step="0.1" value="5" id="radius">
                    </div>
                    <hr>
                    <div id="map" class="img-thumbnail w-100" style="height: 300px;"></div>
                </div>
                <div class="modal-footer">
                    <button id="aplicar_filtro" type="button" class="btn btn-success">Aplicar filtro<i
                            class="d-none fa fa-spinner fa-pulse" id="spinner"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script> // SCRIPT DEL COMPORTAMIENTO DEL MODAL DE FILTRO DE UBICACIÓN

        // Crea el mapa
        function createMap(coords) {
            const map = new google.maps.Map(document.getElementById('map'), {
                center: coords,
                zoom: 4
            });

            return map;
        }
        // Crea el marcador del mapa
        function createMarker(map, coords) {
            var marker = new google.maps.Marker({
                map: map,
                position: coords,
                draggable: true,
            });

            return marker;
        }
        // Crea el círculo del mapa
        function createCircle(map, coords, radius) {
            var circle = new google.maps.Circle({
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.3,
                map: map,
                center: coords,
                radius: radius * 1000, // Convertir km a m
            });

            return circle;
        }
        // Cambia la localización del marcador a la dirección buscada
        async function searchAddress(address, coords, map, geocoder, bounds, marker, circle) {

            geocoder.geocode({ address, bounds }, async (results, status) => {

                if (status === "OK") {

                    //Guardamos las coordenadas
                    coords.lat = await results[0].geometry.location.lat();
                    coords.lng = await results[0].geometry.location.lng();

                    // Cambiamos la posición del marcador
                    marker.setPosition(coords);
                    // Cambiamos la posición del círculo
                    circle.setCenter(coords);
                    // Ajustamos el mapa a los resultados
                    map.fitBounds(circle.getBounds());

                    setAddress(geocoder, document.getElementById("direccion"), coords);

                } else {
                    alert("No se ha encontrado la dirección");
                    console.log("Geocode failed due to: " + status);
                }

            });

        }
        // Establece en el input de dirección la dirección correspondiente a las coordenadas
        function setAddress(geocoder, input, coords) {

            geocoder.geocode({ location: coords }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        input.value = results[0].formatted_address;
                    } else {
                        window.alert("No se han podido localizar las coordenadas");
                        console.log("No se han podido localizar las coordenadas");
                    }
                } else {
                    window.alert("No se han podido localizar las coordenadas");
                    console.log("Geocoder failed due to: " + status);
                }
            });

        }
        // Modifica el radio del círculo
        function modifyRadius(map, circle, radius) {
            circle.setRadius(radius * 1000);
            map.fitBounds(circle.getBounds());
        }

        function initMap() {

            //// Inicialización

            // Instanciamos el objeto de cordenadas, iniciado en Salamanca
            const coords = { lat: 40.973672887751604, lng: -5.66406277873948 }
            // Instanciamos el mapa
            const map = createMap(coords);
            // Instanciamos el codificador direccion<->coordenadas
            const geocoder = new google.maps.Geocoder();
            // Inicializamos el marcador
            const marker = createMarker(map, coords);
            // Inicializamos el radio, en km
            let radio = 5;
            // Inicializamos el círculo
            const circle = createCircle(map, coords, radio);
            // Enfocamos el mapa en el viewport del círculo
            map.fitBounds(circle.getBounds());

            //// Manejo de eventos

            // Eventos de introducir dirección en la barra
            document.getElementById("direccion").addEventListener("keyup", (event) => {
                // El código 13 es el equivalente a la tecla Enter
                if (event.keyCode === 13) {
                    event.preventDefault();
                    const address = event.target.value;
                    searchAddress(address, coords, map, geocoder, map.getBounds(), marker, circle);
                }
            });
            document.getElementById("buscar_direccion").addEventListener("click", (event) => {
                event.preventDefault();
                const address = document.getElementById("direccion").value;
                const result = searchAddress(address, coords, map, geocoder, map.getBounds(), marker, circle);
            });

            // Evento de modificar el radio del área de búsqueda
            document.getElementById("radius").addEventListener("input", (event) => {
                radio = parseFloat(event.target.value);
                modifyRadius(map, circle, radio);
                document.getElementById("showRadius").innerText = `${radio} km`;
            });

            // Evento de cambiar el marcador de coordenadas
            google.maps.event.addListener(marker, "dragend", async (event) => {
                const input = document.getElementById("direccion");
                coords.lat = await event.latLng.lat();
                coords.lng = await event.latLng.lng();
                setAddress(geocoder, input, coords);
                circle.setCenter(coords);
                map.fitBounds(circle.getBounds());
            });

            // Evento de aplicación del filtro de búsqueda
            document.getElementById("aplicar_filtro").addEventListener("click", (event) => {
                event.preventDefault();
                document.getElementById("spinner").classList.remove("d-none");
                const urlSearchParams = new URLSearchParams(window.location.search);
                const params = Object.fromEntries(urlSearchParams.entries());
                console.log("Params: ", params);
                window.location.href = `?lat=${coords.lat}&lng=${coords.lng}&radio=${radio}`;
                document.getElementById("spinner").classList.add("d-none");
            });

        }

    </script>

    <%# Script de la api de maps; debe ir tras la función initMap %>
        <script src="https://maps.googleapis.com/maps/api/js?key=<%= maps_key %>&callback=initMap&libraries=&v=weekly"
            async></script>

        <%- include("../templates/footer"); %>