<%- include("../templates/header.ejs", { tipoNavbar: "logged" , tituloPestana: "Grafiti DB" , username: user.name,
    index: 2 }) %>

    <div class="container-fluid my-4">
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h3 class="d-inline">Grafiti DB</h3>
                        <div class="btn-group float-right">
                            <button class="d-inline dropdown-toggle btn btn-info" type="button"
                                data-toggle="dropdown">Filtrar
                                <!--span class="material-icons-outlined">filter_list</span--> <i class="fa fa-bars"
                                    aria-hidden="true"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" type="button" data-toggle="modal"
                                    data-target="#filtro-zona">por zona <i class="fa fa-map-marker ml-1"
                                        aria-hidden="true"></i>
                                </a>
                                <a class="dropdown-item" type="button" data-toggle="modal"
                                    data-target="#filtro-zona">por fecha <i class="fa fa-calendar ml-1"
                                        aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <% if (grafitis.length> 0) { %>
                            <div class="row">
                                <% for(const image of grafitis) { %>
                                    <div class="col-4 col-sm-3 col-lg-2 mb-2" style="position: relative">
                                        <a class="" href="/usuario/grafiti/<%= image._id %>">
                                            <img src="/api/grafitis/get-thumbnail/<%= image._id %>"
                                                alt="<%= image.description %>" class="w-100 h-100 img img-thumbnail"
                                                style="display: block">
                                            <%# if (image.gps.latitude!=0 || image.gps.longitude!=0) { %>
                                                <!--i class="fa fa-map-marker-alt"
                                                    style="position: absolute; bottom:0; left:0;"></i-->
                                                <%# } %>
                                        </a>
                                        <!--div class="row">
                                            <a class="card-link col" href="">
                                                <span class="text-dark small float-right"><#%= image.user.email %></span>
                                            </a>
                                        </div-->
                                    </div>
                                    <% } %>
                            </div>
                            <% } else { %>
                                <h3 class="display-4 text-center justify-content-center">Aún no hay ninguna imagen en la
                                    base de datos</h3>
                                <% } %>
                    </div>

                    <div class="card-footer">
                        <!-- ELEMENTO DE PAGINACIÓN -->
                        <%- include("../templates/pagination.ejs", { pagina, limPages }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CODIGO DEL MODAL DE FILTRO POR ZONA -->
    <div class="modal fade" id="filtro-zona">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Seleccione el centro</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="floating-panel">
                        <div class="row mx-2">
                            <div class="input-group">
                                <input id="direccion" type="text" class="form-control" placeholder="Dirección" autocomplete="off">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary"
                                        id="buscar_direccion">Buscar</button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row mx-2">
                            <div class="form-inline">
                                <label class="d-inline col-3" for="formControlRange">Rango</label>
                                <input type="range" class="d-inline form-control-range col-9" autocomplete="off" min="1" max="200" step="1"
                                    value="5" id="formControlRange">
                                <div class="col-12 justify-content-center mt-1">
                                    <input type="number" autocomplete="off" min="1" max="200" step="1" id="showRange" value="5"
                                        class="form-control col-4 d-inline">
                                    <label for="showRange" class="d-inline"> km</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div id="modalmap" class="img-thumbnail w-100" style="height: 300px;"></div>
                </div>
                <div class="modal-footer">
                    <button id="guardar_ubicacion" type="button" class="btn btn-success">Aplicar filtro<i
                            class="d-none fa fa-spinner fa-pulse" id="spinner"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script> // Script del modal

        var radio = 5;

        // Al dar enter en la barra de búsqueda de direcciones
        document.getElementById("direccion").addEventListener("keyup", function (event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                console.log("Buscando...");
                // Trigger the button element with a click
                document.getElementById("buscar_direccion").click();
            }
        });

        let modalmarker = null;
        let modalcircle = null;

        // Initialize and add the map
        function initMap() {

            // El geocoder, convierte direcciones a coordenadas y viceversa
            const geocoder = new google.maps.Geocoder();

            // Manejador del evento final de arrastre del marcador
            const dragend = async (event) => {
                geocoder.geocode({ location: event.latLng }, (results, status) => {
                    if (status === "OK") {
                        if (results[0]) {
                            document.getElementById("direccion").value = results[0].formatted_address;
                        } else {
                            window.alert("No results found");
                        }
                    } else {
                        window.alert("Geocoder failed due to: " + status);
                    }
                });

                coords.lat = await event.latLng.lat();
                coords.lng = await event.latLng.lng();

                if (modalcircle) modalcircle.setMap(null);
                modalcircle = new google.maps.Circle({
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#FF0000",
                    fillOpacity: 0.3,
                    map: modalmap,
                    center: event.latLng,
                    radius: radio * 1000,
                });
            }

            document.getElementById("formControlRange").addEventListener("input", (event) => {
                    document.getElementById("showRange").value = event.target.value;
                    radio = parseInt(event.target.value);
                    if (modalcircle) modalcircle.setMap(null);
                    modalcircle = new google.maps.Circle({
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.3,
                        map: modalmap,
                        center: coords,
                        radius: radio * 1000,
                    });
            });

            document.getElementById("showRange").addEventListener("input", (event) => {
                document.getElementById("formControlRange").value = event.target.value;
                radio = parseInt(event.target.value);
                if (modalcircle) modalcircle.setMap(null);
                modalcircle = new google.maps.Circle({
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#FF0000",
                    fillOpacity: 0.3,
                    map: modalmap,
                    center: coords,
                    radius: radio * 1000,
                });
            });

            // Convierte una dirección en una coordenada y apunta en el mapa a ella
            function geocodeAddress(geocoder, resultsMap, address) {
                geocoder.geocode({ address, bounds: resultsMap.getBounds() }, async (results, status) => {
                    if (status === "OK") {
                        // Ajustamos el mapa a los resultados
                        modalmap.fitBounds(results[0].geometry.viewport);
                        //Guardamos las coordenadas
                        coords.lat = await results[0].geometry.location.lat();
                        coords.lng = await results[0].geometry.location.lng();
                        // Creamos el marcador para indicar la posicion
                        if (modalmarker) modalmarker.setMap(null);
                        modalmarker = new google.maps.Marker({
                            map: modalmap,
                            position: coords,
                            draggable: true
                        });
                        if (modalcircle) modalcircle.setMap(null);
                        modalcircle = new google.maps.Circle({
                            strokeColor: "#FF0000",
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: "#FF0000",
                            fillOpacity: 0.3,
                            map: modalmap,
                            center: coords,
                            radius: radio * 1000,
                        });
                        google.maps.event.addListener(modalmarker, "dragend", dragend);

                        geocoder.geocode({ location: results[0].geometry.location }, (results, status) => {
                            if (status === "OK") {
                                if (results[0]) {
                                    document.getElementById("direccion").value = results[0].formatted_address;
                                } else {
                                    window.alert("No results found");
                                }
                            } else {
                                window.alert("Geocoder failed due to: " + status);
                            }
                        });

                    } else {
                        alert("Geocode was not successful for the following reason: " + status);
                    }
                });
            }

            // Ubicación del marcador
            let coords = { lat: null, lng: null };

            document.getElementById("guardar_ubicacion").addEventListener("click", async (event) => {

                // Evitamos que recargue la página
                event.preventDefault();
                document.getElementById("spinner").classList.remove("d-none");

                try {
                    coords.lat = await modalmarker.getPosition().lat();
                    coords.lng = await modalmarker.getPosition().lng();

                    // Redirigimos a la página filtrada
                    window.location.href = `?lat=${coords.lat}&lng=${coords.lng}&radio=${radio}`

                    document.getElementById("spinner").classList.add("d-none");
                    // Comprobamos que no haya fallado
                    if (!respuesta.success) {
                        console.log("Fallo en respuesta: ", respuesta.message);

                        document.getElementById("contenido").innerText = "Vuelva a intentarlo y si el problema persiste contacte con soporte.";
                        document.getElementById("contenido_adicional").innerText = respuesta.message;
                        $("#ubicacion").modal("hide");
                        $("#eliminacion").modal("hide");
                        $('#modal').modal();
                    } else {
                        console.log(respuesta)
                        document.location.reload();
                    }

                } catch (error) {
                    console.log("Catch error: ", error);

                    document.getElementById("contenido").innerText = "Vuelva a intentarlo y si el problema persiste contacte con soporte.";
                    document.getElementById("contenido_adicional").innerText = error;
                    $("#ubicacion").modal("hide");
                    $("#eliminacion").modal("hide");
                    $('#modal').modal();
                }
            });

            let modalmap;
            geocoder.geocode({ address: "Salamanca, Spain" }, async (results, status) => {
                if (status === "OK") {
                    const loc = results[0].geometry.location;
                    coords.lat = loc.lat();
                    coords.lng = loc.lng();
                    // The modalmap, centered at grafiti coords
                    modalmap = new google.maps.Map(document.getElementById("modalmap"), {
                        zoom: 5,
                        center: coords,
                    });
                    // The marker, positioned at grafiti coords
                    modalmarker = new google.maps.Marker({
                        position: coords,
                        map: modalmap,
                        draggable: true
                    });
                    if (modalcircle) modalcircle.setMap(null);
                    modalcircle = new google.maps.Circle({
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.3,
                        map: modalmap,
                        center: coords,
                        radius: radio * 1000,
                    });
                    google.maps.event.addListener(modalmarker, "dragend", dragend);
                    document.getElementById("direccion").value = "Salamanca, Spain";
                } else {
                    alert("No se ha podido determinar la ubicación: " + status);
                }
            });

            document.getElementById("buscar_direccion").addEventListener("click", () => {
                const boton = document.getElementById("direccion");
                geocodeAddress(geocoder, modalmap, boton.value);
            });

        }

    </script>
    <%# Script de la api de maps; debe ir tras la función initMap %>
        <script src="https://maps.googleapis.com/maps/api/js?key=<%= maps_key %>&callback=initMap&libraries=&v=weekly"
            async></script>

        <%- include("../templates/footer"); %>